<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>NZIPR Pacific Aid Map</title>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyCCAfY8R6Sr29NG_AZx_piVdzOVuyRDDTI"></script>
    <script src="https://googlemaps.github.io/js-map-label/src/maplabel-compiled.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <link href="style.css" type="text/css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="text/javascript">
      $(function() {
        function get_query() {
          var url = location.href;
          var qs = url.substring(url.indexOf('#') + 1).split('&');
          for (var i = 0, result = {}; i < qs.length; i++) {
            qs[i] = qs[i].split('=');
            result[qs[i][0]] = decodeURIComponent(qs[i][1]);
          }
          return result;
        }

        var $_GET = get_query();
        
        // Currency formatter
        
        window.$format = function(sum) {
          sum /= 1E4;
          sum = Math.round(sum);
          sum /= 1E2
          return '$' + sum.toLocaleString() + 'M';
        }
        
        // Timeline
        
        window.min = 1973;
        window.max = 1974;
        
        $( "#timeline" ).slider({
          range: true,
          min: 1973,
          max: 2012,
          values: [ window.min, window.max ],
          slide: function( event, ui) {
            window.min = ui.values[0];
            window.max = ui.values[1];
            $("#year").text(window.min + " - " + window.max);
            renderData();
          },
          change: function( event, ui ) {
            window.min = ui.values[0];
            window.max = ui.values[1];
            $("#year").text(window.min + " - " + window.max);
            renderData();
          }
        });
        $("#year").text($("#timeline").slider("values", 0) +
          " - " + $("#timeline").slider("values", 1));
          
        $('.play').click(function() {
          if (!window.t) {
            window.t = setInterval(function() {
              if ($( "#timeline" ).slider( "option", "max" ) == window.max) {
                window.max = window.min // go back to start
              }
              $("#timeline").slider("values", 1, window.max+1);
            }, 1000);
            $('.play i').text('pause');
          } else {
            clearInterval(window.t);
            window.t = false;
            $('.play i').text('play_arrow');
          }
        });
        
        // Map
        
        var mapStyle = [
          {
            "stylers": [
              { "visibility": "off" }
            ]
          },{
            "featureType": "landscape.natural",
            "elementType": "geometry.fill",
            "stylers": [
              { "lightness": 100 },
              { "visibility": "on" }
            ]
          },{
            "featureType": "water",
            "elementType": "geometry.fill",
            "stylers": [
              { "visibility": "on" },
              { "hue": "#007fff" },
              { "lightness": -13 }
            ]
          }
        ];
        
        window.map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -7.7, lng: -180},
          zoom: 4,
          styles: mapStyle,
          disableDefaultUI: true,
          zoomControl: true
        });
          
        // Load knowledge
        
        $.getJSON("cc_latlng.json", function(cc_map) {
          window.cc_map = cc_map;
          $.getJSON("cc_names.json", function(cc_names) {
            window.cc_names = cc_names;
            $.getJSON("http://webdb.cer.auckland.ac.nz/nzipr/get_data.php", function(data) {
              window.data = data;
              renderData();
            });
          });
        });
        
        window.countryCircles = {}
        window.countryLabels = {}
        
        function renderData() {
          console.log('rendering');
          var dest = {}
          for (var e of window.data) {
            if (e.year >= window.min && e.year <= window.max) {
              if (dest[e.recipient_iso]) {
                dest[e.recipient_iso] += e.$;
              } else {
                dest[e.recipient_iso] = e.$;
              }
            }
          }
          for (var i in dest) {
            var aid_sum = dest[i];
            var radius = aid_sum / 10000;
            var latlng = window.cc_map[i];
            var center = new google.maps.LatLng(latlng[0], latlng[1]);
            var countryName = window.cc_names[i];
            if (window.countryCircles[i]) {
              window.countryCircles[i].setRadius(radius);
              window.countryLabels[i].set('text', countryName + ': ' + window.$format(aid_sum));
            } else {
              window.countryCircles[i] = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: window.map,
                center: center,
                radius: radius
              });
              window.countryLabels[i] = new MapLabel({
                text: countryName + ': ' + window.$format(aid_sum),
                position: center,
                map: map,
                fontSize: 15,
                fontColor: 'black',
                strokeColor: 'white',
                strokeWeight: 0,
                align: 'center'
              });
            }
          }
          for (var i in countryCircles) {
            if (!dest[i]) {
              countryCircles[i].setRadius(0);
              countryLabels[i].set('text', '');
            }
          }
        }
    });
  </script>
  </head>

  <body>
    <div id="timemap">
        <div id="timelinecontainer">
          <h3 id='title'>NZIPR Pacific Aid Map</h3>
          <div id="timeline"></div>
          <p style='float:left'>Year: <span id='year'></span></p>
          <button class='play' style='float:left; margin-left: 10px;margin-top: 10px;'><i class="material-icons">play_arrow</i></button>
        </div>
        <div id="map"></div>
    </div>
  </body>
</html>
